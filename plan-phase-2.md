Plan de Próximos Pasos para OptimizadorPro¡Felicidades por el increíble progreso con OptimizadorPro! Has implementado el núcleo de las optimizaciones con una arquitectura limpia y profesional. Ahora vamos a añadir algunas de las funcionalidades más potentes que faltan.1. Implementación de "Eliminar CSS no Utilizado" (Método Manual)Esta es la funcionalidad conocida como RUCSS en WP Rocket. Como discutimos, replicar su sistema automatizado es extremadamente complejo y costoso. En su lugar, implementaremos la versión manual, que ofrece el mismo beneficio de rendimiento y es perfecta para un plugin open source.El concepto es simple:El usuario genera su "CSS Crítico" (el CSS mínimo para la parte visible de la página) usando una herramienta online.Pega ese CSS en nuestro plugin.Nosotros lo insertamos "inline" en el HTML y cargamos el resto de las hojas de estilo de forma asíncrona.Plan de Acción:Paso 1: Modificar la Interfaz de Usuario (UI)En la pestaña de optimización de CSS, añade un textarea con el título: "CSS Crítico (Manual)".Añade una descripción clara: "Pega aquí el CSS crítico para tus páginas. Esto se insertará en el <head> para optimizar la carga visual. El resto del CSS se cargará de forma asíncrona."Paso 2: Crear el CriticalCSSSubscriberDentro de inc/Common/Subscriber/, crea una nueva clase CriticalCSSSubscriber.php.Esta clase se encargará de dos cosas:Inyectar el CSS Crítico:Engánchate a wp_head con una prioridad alta (ej. 1).En el callback, obtén el contenido del textarea de los ajustes.Si no está vacío, imprímelo dentro de una etiqueta <style id="optimizador-pro-critical-css"> ... </style>.Cargar el resto del CSS de forma asíncrona:Engánchate al filtro style_loader_tag.En el callback, comprueba de nuevo si el CSS crítico está activo.Si lo está, modifica la etiqueta <link> de cada hoja de estilo (que no esté en la lista de exclusiones) para que no bloquee el renderizado. La forma más robusta de hacerlo es:// Dentro del filtro 'style_loader_tag'
if ( ! is_admin() && ! empty( $opciones['critical_css'] ) ) {
    $tag = str_replace( "rel='stylesheet'", "rel='preload' as='style' onload=\"this.rel='stylesheet'\"", $tag );
    $tag .= "<noscript><link rel='stylesheet' href='" . esc_url( $href ) . "'></noscript>";
}
return $tag;
Nota: El método rel='preload' es más moderno que media='print'. Usa este.¡Y listo! Con esto, has implementado una de las optimizaciones más avanzadas de una manera pragmática y eficiente.2. Siguientes Funcionalidades (Victorias Fáciles de Alto Impacto)Aquí tienes un plan para tres funcionalidades más que llevarán a OptimizadorPro al siguiente nivel. Sigue la arquitectura que ya has establecido.Funcionalidad 1: Retrasar Ejecución de JavaScript (Delay JS)Esta es, junto con RUCSS, la optimización más potente para las Core Web Vitals. Ya tienes la base, solo hay que activarla.Estrategia:UI: Añade un textarea en la pestaña de JS para "Exclusiones del Retraso de JS".Lógica (DelayJSSubscriber):Usa el búfer de salida (ob_start) para capturar el HTML final.Crea una clase HTMLRewriter que busque todas las etiquetas <script> (tanto inline como con src).Reescribe las etiquetas que no estén en la lista de exclusión:Para <script src="...">, cambia src a data-src.Cambia el type a uno no ejecutable, como type="text/lazy-script".Script Cargador:Inyecta un pequeño script JavaScript inline justo antes de </body>.Este script debe tener un EventListener para la primera interacción del usuario (scroll, mousemove, touchstart, keydown).Cuando se active, el script buscará todas las etiquetas con type="text/lazy-script", les devolverá su type y src originales, lo que provocará su carga y ejecución.Referencia WP Rocket: inc/Engine/Optimization/DelayJS/HTML.php es una excelente inspiración para la lógica de reescritura.Funcionalidad 2: Optimización de Google FontsEsto es relativamente sencillo y soluciona una recomendación muy común de PageSpeed.Estrategia:UI: Añade un simple checkbox: "Optimizar Google Fonts".Lógica (GoogleFontsSubscriber):Usa el búfer de salida.Busca todas las etiquetas <link> que apunten a fonts.googleapis.com/css.Extrae los parámetros family de cada una.Combina todos los parámetros family en una única URL.Asegúrate de que la URL final contenga &display=swap para mejorar el rendimiento.Reemplaza todas las etiquetas originales de Google Fonts por la nueva y única etiqueta <link>.Referencia WP Rocket: inc/Engine/Optimization/GoogleFonts/Combine.php.Funcionalidad 3: Integración con CDNPermitir a los usuarios servir sus assets desde un CDN es una funcionalidad estándar y fácil de implementar.Estrategia:UI: Añade un campo de texto para que el usuario introduzca la URL de su CDN (ej. cdn.misitio.com).Lógica (CDNSubscriber):Usa el búfer de salida.Realiza una simple sustitución de strings en el HTML final. Reemplaza la URL base del sitio (https://misitio.com/wp-content/...) por la URL del CDN (https://cdn.misitio.com/wp-content/...).Asegúrate de reescribir las URLs de los archivos CSS, JS e imágenes.Referencia WP Rocket: inc/Engine/CDN/Subscriber.php.Con estas adiciones, OptimizadorPro no solo replicará las funciones básicas, sino que también ofrecerá las optimizaciones avanzadas que los usuarios más valoran. ¡Excelente trabajo y a seguir adelante!